# ДЗ № 5
**Цель работы**:
- [x] Выполнение шагов, продемонстрированных на вебинаре, с использованием PySpark для обучения
модели обнаружения мошенничества (fraud detection) 
- [x] Поднять MLFlow. 
- [x] Сохранить все артефакты с моделью в MLFlow, обязательно наличие Object Storage
- [x] Настроить переобучение по расписанию при помощи Airflow на новых данных
- [x] Проверить качество и эффективность модели обнаружения мошенничества
<hr>

# Создание модели для обучения выявления мошеннических транзакций
В качестве основной модели я буду использовать Logistic Regression. Она будет обучаться на обработанных данных из предыдущего шага. В качестве учебного примера и экономии ресурсов буду обучать модель на данных за 1 день. В следующем задании попробую обучать за несколько дней. Метрики за каждый цикл обучения будут прогружаться в MLFlow. Процесс обучения включает:

- разбивку на train/test
- создание вектора признаков и его нормализация
- подбор гиперпараметров
- логирование метрик и лучшей модели в MLFlow.
  
Скрипт для обучения модели можно посмотреть [здесь](https://github.com/shakhovak/MLOps_HW/blob/master/HW_5/model_train.py).

# MLFlow
Поднимать MLFlow я буду на отдельной ВМ. Буду оринетироваться на [инструкцию](https://cloud.yandex.ru/ru/docs/datasphere/tutorials/mlflow-datasphere#setup-mlflow) от Yandex. Основные шаги:
1. Создать ВМ с Ubuntu
2. Установить на ней необходимые библиотеки

```python 
conda install -c conda-forge mlflow
conda install -c anaconda boto3
pip install psycopg2-binary
pip install pandas
```
3. Добавить доступы к S3
4. Создать базу данных с помощью сервиса Managed Service for PostgreSQL

![image](https://github.com/shakhovak/MLOps_HW/assets/89096305/31ef11dd-9f08-48c6-9a19-faa0d0a22932)

6. Запустить MLFlow Tracking Server 

# Обучение модели
Для обучения модели я создала кластер для вычислений как в предыдущем задании.
   ![image](https://github.com/shakhovak/MLOps_HW/assets/89096305/71d00252-a0b2-4c5f-8005-0188f01f6819)

При инициализации кластера нужно указать, какие дополнительные пакеты нужно установить для работы со скриптами. Пакеты указываются в свойствах/properties.

```python
pip:mlflow : 2.3.2
pip:urllib3 : 1.26.16
```

# Airflow

Как в предыдущем задании, я подготовила DAG для автоматического выполнения задачи предобработки данных и обучения модели, я создала ВМ c Airflow. Посмотреть DAG можно здесь

> [!IMPORTANT]
> **Я немного поменяла DAG: убрала из него создание и удаление кластера, так как нужно заполнять properties, а этот пункт добавлен в коннектор только с 3 версии Airflow. На ВМ устанавливается автоматически только 2.**
>

![image](https://github.com/shakhovak/MLOps_HW/assets/89096305/a866d782-0dd5-4841-9d0e-f07f5b0f47bb)

 
# Результаты обучения и выводы:
Результаты обучения отражаются в базе данных и в IU MLFlow и приведены на прин-скринах ниже. 
Обучение модели уже на данных за 2 дня дало прирост в метрике. Ожидается, что дальнейшее увеличение обучающей выборке даст дальнейшую точность предсказания.

UI ML Flow -

![image](https://github.com/shakhovak/MLOps_HW/assets/89096305/0051208f-e2f6-4782-90aa-cfbc96e98742)

S3 c артефактом модели:
![image](https://github.com/shakhovak/MLOps_HW/assets/89096305/70d10ec8-48aa-4022-ae0f-b3c4e963d609)

Также сохранилась информация и в базе данных:
![image](https://github.com/shakhovak/MLOps_HW/assets/89096305/1df1ad9c-22bd-4d8e-bdc7-200414733ec6)

После обучения я удалила все ВМ и базы данных.



   
